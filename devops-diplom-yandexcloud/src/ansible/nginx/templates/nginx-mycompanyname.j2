# add_header X-Frame-Options SAMEORIGIN;
# add_header X-Content-Type-Options nosniff;
# add_header X-XSS-Protection "1; mode=block";
# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com; img-src 'self' data: https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; font-src 'self'; frame-src 'none'; object-src 'none'";


# HTTPS server
#

# server {
#    listen 443 ssl default deferred;
#    server_name {{ domain_name }};
#
#    ssl on;
#    ssl_certificate         /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem;
#    ssl_certificate_key     /etc/letsencrypt/live/{{ domain_name }}/privkey.pem;
#    ssl_trusted_certificate /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem;
#
#    ssl_session_cache shared:SSL:50m;
#    ssl_session_timeout 5m;
#    ssl_stapling on;
#    ssl_stapling_verify on;
#
#    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
#    ssl_ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
#
#    ssl_dhparam /etc/nginx/dhparams.pem;
#    ssl_prefer_server_ciphers on;
#
#root /var/www/{{ domain_name }};
#    index index.html index.htm;
#
#    location / {
#        try_files $uri $uri/ =404;
#    }
#}

#http {
#    include       /etc/nginx/mime.types;
#    default_type  application/octet-stream;
#
#    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                      '$status $body_bytes_sent "$http_referer" '
#                      '"$http_user_agent" "$http_x_forwarded_for"';
#    access_log  /var/log/nginx/access.log  main;
#
#    sendfile on;
#    tcp_nopush on;
#    tcp_nodelay on;
#    keepalive_timeout  65;
#    reset_timedout_connection  on;
#    client_body_timeout        35;
#    send_timeout               30;
#
#    gzip on;
#    gzip_min_length     1000;
#    gzip_vary on;
#    gzip_proxied        expired no-cache no-store private auth;
#    gzip_types          text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;
#    gzip_disable        "msie6";
#
#    types_hash_max_size 2048;
#    client_max_body_size 1m;
#    proxy_buffer_size   64k;
#    proxy_buffers   4 64k;
#    proxy_busy_buffers_size   64k;
#    server_names_hash_bucket_size 64;
#
#    include /etc/nginx/modules-enabled/*.conf;
#    include /etc/nginx/conf.d/*.conf;
#    include /etc/nginx/sites-enabled/*;

server {listen 80;
    server_name {{ domain_name }};
    return 301 https://{{ domain_name }}$request_uri;

}

############################################
upstream www {
    server 62.84.118.229:80;
}
upstream gitlab {
    server 192.168.1.13:80;
}
upstream grafana {
    server 192.168.1.14:80;
}
upstream prometheus {
    server 192.168.1.15:80;
}
upstream alertmanager {
    server 192.168.1.16:80;
}

##############################
server {
       listen       443 ssl;
       server_name  {{ domain_name }};

       ssl_certificate      /etc/letsencrypt/live/{{ domain_name }}/cert.pem;
       ssl_certificate_key  /etc/letsencrypt/live/{{ domain_name }}/privkey.pem;

       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

 location / {
        proxy_pass http://www;
#        proxy_set_header Host $host;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#        proxy_set_header X-Real-IP $remote_addr;
            }
        }
###########################
server {
       listen       443 ssl;
       server_name {{ gitlab }};

       ssl_certificate      /etc/letsencrypt/live/{{ gitlab }}/cert.pem;
       ssl_certificate_key  /etc/letsencrypt/live/{{ gitlab }}/privkey.pem;

       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

 location / {
        proxy_pass http://gitlab;
 #       proxy_set_header Host $host;
 #       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 #       proxy_set_header X-Real-IP $remote_addr;
            }
        }
################################

server {
       listen       443 ssl;
       server_name {{ grafana }};

       ssl_certificate      /etc/letsencrypt/live/{{ grafana }}/cert.pem;
       ssl_certificate_key  /etc/letsencrypt/live/{{ grafana }}/privkey.pem;

       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

 location / {
        proxy_pass http://grafana;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
            }
        }
###################################
server {
       listen       443 ssl;
       server_name {{ prometheus }};

       ssl_certificate      /etc/letsencrypt/live/{{ prometheus }}/cert.pem;
       ssl_certificate_key  /etc/letsencrypt/live/{{ prometheus }}/privkey.pem;
       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

 location / {
        proxy_pass http://prometheus;
 #       proxy_set_header Host $host;
 #       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 #       proxy_set_header X-Real-IP $remote_addr;
            }
        }

###################################
server {
       listen       443 ssl;
       server_name {{ alertmanager }};

       ssl_certificate      /etc/letsencrypt/live/{{ alertmanager }}/cert.pem;
       ssl_certificate_key  /etc/letsencrypt/live/{{ alertmanager }}/privkey.pem;
       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

 location / {
        proxy_pass http://alertmanager;
 #       proxy_set_header Host $host;
 #       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 #       proxy_set_header X-Real-IP $remote_addr;
            }
        }
#блок   HTTP:
#}